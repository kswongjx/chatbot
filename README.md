# Custom Chat Widget for n8n Backend

A custom-built chat widget frontend designed to interface with an n8n workflow, enabling AI-driven conversational experiences.

## Project Structure

Use code with caution.
Markdown
/your-repo-name
├── .gitignore
├── README.md
├── index.html # Demo page with configuration
├── config.js # your environment setting file
├── js/
│ └── chat-widget-custom.js # The custom widget script
└── img/
└── logo.jpg # Placeholder for your logo

## Current Features (v1.1)

- **Basic Chat UI:** Toggle button, chat window, header, message display area, text input.
- **Configurable Appearance:** Customize colors, position, and branding (logo, name, welcome text).
- **Client-Side Session Management:** Uses Local Storage to maintain `sessionId`.
- **Webhook Communication:**
  - Sends user text messages to a configurable n8n webhook (POST, JSON).
  - Receives text and rich content (buttons) responses from the n8n webhook.
- **"Start New Chat":**
  - Button to initiate a new session.
  - Sends an `action: 'startSession'` to the backend.
  - Can display initial options (e.g., language selection buttons) returned by n8n.
- **Message Handling:**
  - Handles subsequent user messages via `action: 'sendMessage'`.
  - Displays bot messages, including text and interactive buttons.
- **AI-Driven Intent Options:**
  - Capable of receiving a list of option buttons from n8n in response to a user message.
  - These buttons are dynamically generated by n8n (e.g., after AI intent analysis).
  - Clicking an option button sends a specific `action` and `payload` back to n8n for further processing.
- **Button Click UX:**
  - Displays the clicked button's label as a user message for conversation clarity.
  - Disables buttons in a group after one is clicked, highlighting the selected option.

## Setup and Usage

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/YOUR_USERNAME/YOUR_REPO_NAME.git
    cd YOUR_REPO_NAME
    ```
2.  **Replace Webhook URL Placeholder:**
    - Open `index.html`.
    - Find the `window.MyChatWidgetConfig` script block.
    - Replace `'YOUR_N8N_WEBHOOK_URL_HERE'` with the actual webhook URL from your active n8n workflow.
    - **Crucially:** Do not commit your actual URL if this is a public repository! You will need to handle this replacement when deploying or sharing.
3.  **Add Your Logo:**
    - Place your company logo file (e.g., `logo.jpg`) in the `img/` directory.
    - Update the `branding.logo` path in `index.html` if necessary.
4.  **Set up n8n Workflow:**
    - Create an n8n workflow starting with a **Webhook** node (Method: POST).
    - Configure your workflow to receive JSON data containing `sessionId`, `action`, and potentially `text`.
    - Implement logic to handle:
      - `action: 'startSession'`: This should trigger the initial message sequence (e.g., asking for language).
      - `action: 'sendMessage'`: This handles user's typed input.
      - _Future TODO:_ Implement logic for handling button click payloads sent back from the widget.
    - Ensure your n8n workflow responds with a JSON object containing an `output` field for text messages (e.g., `{ "output": "Your bot response" }`).
    - Activate your n8n workflow and copy its webhook URL.
5.  **Test Locally:**
    - Open `index.html` in your web browser.
    - Open browser Developer Tools (F12) to monitor the Console and Network tabs.
    - Click the chat toggle button, then "Start New Chat", and send messages.
6.  **Deploy:**
    - This is a static site. You can deploy it to any static hosting service like GitHub Pages, Cloudflare Pages, Netlify, Vercel, or a simple web server.
    - **Remember to replace the webhook URL placeholder with your live n8n webhook URL during deployment.**

## Communication Protocol: Frontend (Widget) <=> n8n (Backend)

Communication between the chat widget (`chat-widget-custom.js`) and the n8n backend relies on JSON objects sent via POST requests to the configured n8n webhook URL.

### 1. Frontend (Widget) to n8n (Backend)

All requests from the widget to n8n will include `sessionId` and an `action` property to help n8n route the request.

**Common Structure:**

```json
{
  "sessionId": "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx", // UUID generated by the client
  "action": "actionName",
  // ...other action-specific properties
}

Specific Actions and their Payloads:
A. Initializing a new chat session:
Triggered by: User clicking "Start New Chat" button.
action: "startSession"
Example JSON sent to n8n:

{
  "sessionId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "action": "startSession"
}

B. Sending a user's typed message:
Triggered by: User typing a message and hitting send/enter.
action: "sendMessage"
Example JSON sent to n8n:

{
  "sessionId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "action": "sendMessage",
  "text": "Hello, I need help with my account."
}

C. User clicks a button (e.g., language selection, AI-suggested option):
Triggered by: User clicking a button displayed in the chat.
The action and the content of the payload are determined by what n8n sent when creating the button.
The widget takes the action and payload from the button's definition and sends them. The payload object's keys are spread into the root of the JSON sent to n8n.
Example 1: Language Selection Button Click (assuming button was defined with action: "languageSelect", payload: { "language": "en" })

{
  "sessionId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "action": "languageSelect",
  "language": "en"
}

Example 2: AI-Suggested Option Button Click (assuming button was defined with action: "aiOptionSelected", payload: { "choice": "show_pricing", "topic": "services" })

{
  "sessionId": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "action": "aiOptionSelected",
  "choice": "show_pricing",
  "topic": "services"
}

2. n8n (Backend) to Frontend (Widget)
n8n responds with a JSON object. The widget primarily looks for an output key for text messages and a buttons key for interactive options.
A. Simple Text Response:
Used for: Basic bot replies without interactive elements.
Example JSON expected by the widget:

{
  "output": "The bot's response message goes here."
}

B. Response with Text and/or Buttons:
Used for: Presenting options to the user (e.g., after startSession, or after AI intent analysis).
The output field is optional if only buttons are to be shown, but generally good for context.
Example JSON expected by the widget:

{
  "output": "Please select an option:", // Optional accompanying text
  "buttons": [
    {
      "label": "View Pricing",
      "action": "aiOptionSelected", // This action will be sent back to n8n if clicked
      "payload": { "choice": "show_pricing_details" } // This data will be sent back
    },
    {
      "label": "Contact Support",
      "action": "aiOptionSelected",
      "payload": { "choice": "initiate_support_request" }
    },
    {
      "label": "English",
      "action": "languageSelect",
      "payload": { "language": "en" }
    }
  ]
}

Fields within each button object:
label (String, Required): The text displayed on the button in the chat UI.
action (String, Required): The action value that the widget will send back to n8n when this specific button is clicked. This is used by n8n's Switch node to route the interaction.
payload (Object, Required): An object containing key-value pairs. When the button is clicked, these key-value pairs will be included at the root level of the JSON object sent back to n8n (alongside sessionId and the button's action).

## Known Issues
Chat Widget Scrolling: The chat message area currently may not reliably scroll to the newest message automatically in all scenarios or might lack manual scrollability. Further investigation and fixes are needed for smooth scroll behavior.

## To-Do
"Restart Chat" Button: Implement an in-widget button that allows the user to explicitly clear the current session (both in localStorage and potentially by sending a "killSession" or "restartSession" action to n8n) and start fresh from the welcome screen without needing to manually clear browser cache/storage.
Improve Scroll Behavior: Address the "Known Issues" regarding scrolling.
Typing Indicators: Add visual cues when the bot is "typing" or processing a request.
Error Handling Display: Improve how network or server errors are communicated to the user within the widget UI.


```
